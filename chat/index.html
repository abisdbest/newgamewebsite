<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blooket1 Chat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --body-bg-color: #f0f2f5;
            --chat-bg-color: #ffffff;
            --header-bg: #ffffff;
            --user-message-bg: #0084ff;
            --contact-message-bg: #e4e6eb;
            --text-color: #050505;
            --light-text-color: #ffffff;
            --border-color: #ced0d4;
            --hover-bg: #f2f2f2;
            --icon-color: #606770;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --body-bg-color: #18191a;
            --chat-bg-color: #242526;
            --header-bg: #242526;
            --user-message-bg: #0084ff;
            --contact-message-bg: #3a3b3c;
            --text-color: #e4e6eb;
            --light-text-color: #ffffff;
            --border-color: #3e4042;
            --hover-bg: #3a3b3c;
            --icon-color: #b0b3b8;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .chat-container {
            width: 100%;
            max-width: 850px;
            height: 95vh;
            background-color: var(--chat-bg-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .chat-header {
            padding: 15px 25px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s, border-bottom 0.3s;
        }

        .chat-header h2 { margin: 0; font-size: 1.6em; }
        .settings-icon { font-size: 24px; cursor: pointer; color: var(--icon-color); }

        .chat-messages {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 25px;
            max-width: 75%;
        }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 12px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 500; color: #fff;
            flex-shrink: 0;
        }
        .user .avatar { background-color: var(--user-message-bg); }
        .contact .avatar { background-color: #606770; }

        .message-text { display: flex; flex-direction: column; }
        .username {
            font-size: 0.85em; font-weight: 600;
            margin-bottom: 5px; color: #888;
        }
        .message.user .username { text-align: right; }
        .message-content {
            padding: 12px 18px; border-radius: 20px;
            font-size: 0.95em; line-height: 1.4;
            word-break: break-word;
        }
        .message.user .message-content {
            background-color: var(--user-message-bg); color: var(--light-text-color);
            border-bottom-right-radius: 5px;
        }
        .message.contact .message-content {
            background-color: var(--contact-message-bg); color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            display: flex; padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--header-bg);
            transition: background-color 0.3s, border-top 0.3s;
        }
        .chat-input input {
            flex-grow: 1; border: 1px solid var(--border-color);
            background-color: var(--contact-message-bg);
            border-radius: 25px; padding: 12px 20px;
            font-size: 1em; outline: none; color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .chat-input input:focus { border-color: var(--user-message-bg); }
        .chat-input button {
            border: none; background-color: var(--user-message-bg); color: var(--light-text-color);
            border-radius: 25px; padding: 12px 25px;
            margin-left: 10px; cursor: pointer;
            font-size: 1em; font-weight: 500;
            transition: background-color 0.3s;
        }
        .chat-input button:hover { background-color: #0073e6; }
        
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--chat-bg-color); margin: auto; padding: 30px;
            border: 1px solid var(--border-color); width: 80%; max-width: 400px;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: var(--text-color); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500;}
        .form-group input[type="text"] {
            width: calc(100% - 20px); padding: 10px; border-radius: 5px;
            border: 1px solid var(--border-color); background-color: var(--body-bg-color); color: var(--text-color);
        }

        /* Toggle Switch */
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 4px; bottom: 4px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--user-message-bg); }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            <h2>Blooket1 Chat</h2>
            <div class="settings-icon" id="settings-icon">⚙️</div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be dynamically loaded here -->
        </div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="form-group">
                <label for="username-input">Username</label>
                <input type="text" id="username-input" placeholder="Enter your username">
            </div>
            <div class="toggle-switch">
                <label for="dark-mode-toggle">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
             <div class="toggle-switch">
                <label for="notification-toggle">Notifications</label>
                <label class="switch">
                    <input type="checkbox" id="notification-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ======================================================================
            // --- CONFIGURATION ---
            // Your Worker URL is pre-filled below
            const WORKER_URL = "blooket1-chat.info-blooket1.workers.dev";
            // ======================================================================

            const WEBSOCKET_URL = `wss://${WORKER_URL}/websocket`;
            const HISTORY_URL = `https://${WORKER_URL}/history`;

            // --- DOM Elements ---
            const chatHeader = document.querySelector('.chat-header h2');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const settingsIcon = document.getElementById('settings-icon');
            const settingsModal = document.getElementById('settings-modal');
            const closeModal = document.querySelector('.close-button');
            const usernameInput = document.getElementById('username-input');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const notificationToggle = document.getElementById('notification-toggle');

            // --- App State ---
            let currentUser = { username: 'Anonymous' };
            let ws;

            // --- Main Setup ---
            loadSettings();
            connectWebSocket();
            fetchChatHistory();
            
            // --- Event Listeners ---
            sendButton.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });
            settingsIcon.addEventListener('click', () => {
                usernameInput.value = currentUser.username; // Ensure modal shows current name
                settingsModal.style.display = 'flex';
            });
            closeModal.addEventListener('click', handleUsernameChange);
            window.addEventListener('click', (e) => { if (e.target == settingsModal) handleUsernameChange(); });
            darkModeToggle.addEventListener('change', () => {
                document.documentElement.dataset.theme = darkModeToggle.checked ? 'dark' : 'light';
                saveSettings(); // Save dark mode state
            });
            notificationToggle.addEventListener('change', () => {
                if (notificationToggle.checked && Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }
                saveSettings(); // Save notification state
            });

            // --- WebSocket Functions ---
            function connectWebSocket() {
                updateHeader('Connecting...');
                ws = new WebSocket(WEBSOCKET_URL);

                ws.onopen = () => { 
                    updateHeader('Blooket1 Chat - Connected'); 
                    // Set initial username with the server upon connecting
                    handleUsernameChange(true);
                };
                ws.onmessage = (event) => { handleServerMessage(JSON.parse(event.data)); };
                ws.onclose = () => {
                    updateHeader('Blooket1 Chat - Reconnecting...');
                    setTimeout(connectWebSocket, 3000);
                };
                ws.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    updateHeader('Blooket1 Chat - Connection Error');
                    ws.close();
                };
            }

            function handleServerMessage(message) {
                switch (message.type) {
                    case 'newMessage':
                        addMessageToUI(message);
                        if (document.hidden) showNotification(message);
                        break;
                    case 'usernameSuccess':
                        const isInitialSetup = message.oldUsername && message.oldUsername.startsWith('Anonymous_');
                        if (!isInitialSetup) { // Don't show update messages for the initial anonymous name
                           updateUIAfterUsernameChange(message.oldUsername, message.newUsername);
                        }
                        currentUser.username = message.newUsername;
                        saveSettings();
                        break;
                    case 'usernameError':
                        alert(message.message); // Show error from server
                        usernameInput.value = currentUser.username; // Revert input to current name
                        break;
                    case 'userUpdated':
                        // Another user changed their name, update past messages
                        updateUIAfterUsernameChange(message.oldUsername, message.newUsername);
                        break;
                }
            }

            // --- Core Functions ---
            function handleSendMessage() {
                const text = messageInput.value.trim();
                if (text === '' || !ws || ws.readyState !== WebSocket.OPEN) return;
                
                // Send a structured message to the server
                ws.send(JSON.stringify({ type: 'sendMessage', text: text }));
                
                messageInput.value = '';
            }

            async function fetchChatHistory() {
                try {
                    const response = await fetch(HISTORY_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const history = await response.json();
                    chatMessages.innerHTML = '';
                    history.forEach(msg => addMessageToUI(msg, true));
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    console.error("Error fetching chat history:", error);
                    addSystemMessage("Could not load chat history.");
                }
            }

            function addMessageToUI(message, isHistory = false) {
                const messageType = (message.sender === currentUser.username) ? 'user' : 'contact';
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message', messageType);
                // Add data-username attribute to easily find messages by a user
                messageContainer.dataset.username = message.sender;

                const avatar = document.createElement('div');
                avatar.classList.add('avatar');
                avatar.textContent = message.sender.charAt(0).toUpperCase();

                const messageTextContainer = document.createElement('div');
                const usernameElement = document.createElement('div');
                usernameElement.classList.add('username');
                usernameElement.textContent = message.sender;
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                messageContent.textContent = message.text;
                
                messageTextContainer.appendChild(usernameElement);
                messageTextContainer.appendChild(messageContent);
                
                if (messageType === 'user') {
                    messageContainer.appendChild(messageTextContainer);
                    messageContainer.appendChild(avatar);
                } else {
                    messageContainer.appendChild(avatar);
                    messageContainer.appendChild(messageTextContainer);
                }

                chatMessages.appendChild(messageContainer);
                if (!isHistory) chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // --- Settings & UI Helpers ---
            function handleUsernameChange(isInitial = false) {
                if (!isInitial) {
                   settingsModal.style.display = 'none';
                }
                const newUsername = usernameInput.value.trim();
                if (newUsername && newUsername !== currentUser.username) {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        alert("Not connected to the server. Cannot change username.");
                        return;
                    }
                    ws.send(JSON.stringify({ type: 'setUsername', newUsername: newUsername }));
                }
            }
            
            function updateUIAfterUsernameChange(oldUsername, newUsername) {
                // Find all message containers sent by the old username
                const userMessages = document.querySelectorAll(`.message[data-username="${oldUsername}"]`);
                
                userMessages.forEach(msg => {
                    // Update the data attribute
                    msg.dataset.username = newUsername;
                    // Update the visible username text
                    const usernameEl = msg.querySelector('.username');
                    if (usernameEl) usernameEl.textContent = newUsername;
                    // Update the avatar initial
                    const avatarEl = msg.querySelector('.avatar');
                    if (avatarEl) avatarEl.textContent = newUsername.charAt(0).toUpperCase();

                    // If the updated name is the CURRENT user's new name, fix styling to 'user'
                    if (newUsername === currentUser.username) {
                        if (!msg.classList.contains('user')) {
                            msg.classList.remove('contact');
                            msg.classList.add('user');
                            // Reorder elements for user messages
                            const content = msg.querySelector('.message-text');
                            const avatar = msg.querySelector('.avatar');
                            msg.appendChild(content);
                            msg.appendChild(avatar);
                        }
                    }
                });
            }

            function addSystemMessage(text) {
                const sysMsg = document.createElement('div');
                sysMsg.style.textAlign = 'center';
                sysMsg.style.color = '#888';
                sysMsg.style.marginBottom = '25px';
                sysMsg.textContent = text;
                chatMessages.appendChild(sysMsg);
            }

            function showNotification({ sender, text }) {
                if (Notification.permission === 'granted' && sender !== currentUser.username) {
                    new Notification(`New message from ${sender}`, { body: text });
                }
            }

            function updateHeader(text) { chatHeader.textContent = text; }

            function saveSettings() {
                localStorage.setItem('chatAppSettings', JSON.stringify({
                    username: currentUser.username,
                    darkMode: darkModeToggle.checked,
                    notifications: notificationToggle.checked
                }));
            }

            function loadSettings() {
                const saved = JSON.parse(localStorage.getItem('chatAppSettings'));
                const randomId = Math.floor(Math.random() * 1000);
                let username = `Anonymous_${randomId}`;
                if (saved) {
                    username = saved.username || `Anonymous_${randomId}`;
                    darkModeToggle.checked = saved.darkMode || false;
                    notificationToggle.checked = saved.notifications || false;
                    if (darkModeToggle.checked) document.documentElement.dataset.theme = 'dark';
                }
                currentUser.username = username;
                usernameInput.value = username;
            }
        });
    </script>

</body>
</html>